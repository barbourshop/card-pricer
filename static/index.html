<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay Card Pricer</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Add styles for recent sales and active listings */
        .recent-sale-row {
            background-color: #f0f8ff; /* Light blue background for recent sales */
        }
        
        .active-listing-row {
            background-color: #f0fff0; /* Light green background for active listings */
        }
        
        /* Style for section descriptions */
        .section-description {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            font-style: italic;
            color: #666;
        }
        
        #recent-sales-section .section-description {
            background-color: #e6f3ff;
            border-left: 4px solid #0066cc;
        }
        
        #active-listings-section .section-description {
            background-color: #e6ffe6;
            border-left: 4px solid #009933;
        }
        
        /* Add a note to explain the difference */
        .data-table::before {
            content: "Recent Sales: Items that have been sold in the last 90 days";
            display: block;
            font-style: italic;
            margin-bottom: 10px;
            color: #666;
        }
        
        #active-listings-section .data-table::before {
            content: "Active Listings: Items currently available for purchase";
            display: block;
            font-style: italic;
            margin-bottom: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>eBay Card Pricer</h1>
            <div id="user-info"></div>
            <button onclick="signOut()" class="btn-secondary signout-btn">Sign Out</button>
        </header>

        <!-- Login Section -->
        <section id="login-section">
            <div class="login-container">
                <h2>Sign in to continue</h2>
                <div id="g_id_onload"
                     data-client_id="209283856607-pjsulss4dthq0oo6f192bd3bc02tcn9t.apps.googleusercontent.com"
                     data-callback="onSignIn">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
            </div>
        </section>

        <!-- Main Content Section (hidden by default) -->
        <section id="main-content" style="display: none;">
            <div class="content-layout">
                <div class="card-pricing-form">
                    <h2>Card Details</h2>
                    <form id="pricing-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="brand">Brand:</label>
                                <input type="text" id="brand" name="brand" required placeholder="e.g., Topps">
                            </div>
                            <div class="form-group">
                                <label for="set_name">Set Name:</label>
                                <input type="text" id="set_name" name="set_name" required placeholder="e.g., Chrome">
                            </div>
                            <div class="form-group">
                                <label for="year">Year:</label>
                                <input type="text" id="year" name="year" required placeholder="e.g., 2023">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="player_name">Player Name:</label>
                                <input type="text" id="player_name" name="player_name" placeholder="e.g., Mike Trout">
                            </div>
                            <div class="form-group">
                                <label for="card_number">Card Number:</label>
                                <input type="text" id="card_number" name="card_number" placeholder="e.g., 123">
                            </div>
                            <div class="form-group">
                                <label for="card_variation">Card Variation:</label>
                                <input type="text" id="card_variation" name="card_variation" placeholder="e.g., Refractor">
                            </div>
                            <div class="form-group">
                                <label for="condition">Condition:</label>
                                <select id="condition" name="condition" required>
                                    <option value="">Select condition</option>
                                    <option value="graded">Graded</option>
                                    <option value="ungraded">Ungraded</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Get Price</button>
                    </form>
                </div>

                <div class="results-section" style="display: none;">
                    <h2>Pricing Results</h2>
                    <div id="pricing-results">
                        <div class="price-summary">
                            <div class="predicted-price">
                                <h3>Predicted Price: <span id="predicted-price">$0.00</span></h3>
                                <p>Confidence Score: <span id="confidence-score">0%</span></p>
                            </div>
                            <div class="market-analysis">
                                <div class="analysis-item">
                                    <span class="label">Market Trend:</span>
                                    <span id="market-trend" class="value">-</span>
                                </div>
                                <div class="analysis-item">
                                    <span class="label">Supply Level:</span>
                                    <span id="supply-level" class="value">-</span>
                                </div>
                                <div class="analysis-item">
                                    <span class="label">Price Trend:</span>
                                    <span id="price-trend" class="value">-</span>
                                </div>
                                <div class="analysis-item">
                                    <span class="label">Average Sale Price:</span>
                                    <span id="avg-sale-price" class="value">-</span>
                                </div>
                                <div class="analysis-item">
                                    <span class="label">Average Active Price:</span>
                                    <span id="avg-active-price" class="value">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="sales-data">
                            <div id="recent-sales-section" class="collapsible-section">
                                <button class="collapsible-btn">
                                    Recent Sales <span class="count">(0)</span>
                                    <span class="arrow">▶</span>
                                </button>
                                <div class="collapsible-content">
                                    <div class="section-description">
                                        <p>Items that have been sold in the last 90 days</p>
                                    </div>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Price</th>
                                                <th>Condition</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-sales-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="active-listings-section" class="collapsible-section">
                                <button class="collapsible-btn">
                                    Active Listings <span class="count">(0)</span>
                                    <span class="arrow">▶</span>
                                </button>
                                <div class="collapsible-content">
                                    <div class="section-description">
                                        <p>Items currently available for purchase</p>
                                    </div>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Price</th>
                                                <th>Condition</th>
                                                <th>Type</th>
                                            </tr>
                                        </thead>
                                        <tbody id="active-listings-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        function onSignIn(googleUser) {
            // Get the ID token
            const idToken = googleUser.credential;
            
            // Send the token to your backend
            fetch('/auth/google', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id_token: idToken })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide login section and show main content
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    
                    // Store user info and token
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('auth_token', idToken);
                    
                    // Update UI with user info
                    document.getElementById('user-info').textContent = `Logged in as: ${data.user.email}`;
                    
                    // Initialize collapsible sections
                    initializeCollapsibleSections();
                } else {
                    alert('Login failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during login');
            });
        }

        function initializeCollapsibleSections() {
            console.log('Initializing collapsible sections');
            const buttons = document.querySelectorAll('.collapsible-btn');
            console.log('Found buttons:', buttons.length);

            buttons.forEach(button => {
                console.log('Setting up button:', button.textContent);
                const content = button.nextElementSibling;
                
                // Set initial state
                content.style.display = 'none';
                button.querySelector('.arrow').textContent = '▶';
                
                button.onclick = function() {
                    console.log('Button clicked:', button.textContent);
                    console.log('Current display:', content.style.display);
                    
                    // Toggle display
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        button.querySelector('.arrow').textContent = '▼';
                    } else {
                        content.style.display = 'none';
                        button.querySelector('.arrow').textContent = '▶';
                    }
                };
            });
        }

        // Initialize collapsible sections immediately
        initializeCollapsibleSections();

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            const user = localStorage.getItem('user');
            const authToken = localStorage.getItem('auth_token');
            
            if (user && authToken) {
                const userData = JSON.parse(user);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('user-info').textContent = `Logged in as: ${userData.email}`;
                
                // Initialize collapsible sections again after login
                initializeCollapsibleSections();
            }
            
            // Add form submission handler
            document.getElementById('pricing-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form values
                const brand = document.getElementById('brand').value;
                const set_name = document.getElementById('set_name').value;
                const year = document.getElementById('year').value;
                const player_name = document.getElementById('player_name').value;
                const card_number = document.getElementById('card_number').value;
                const card_variation = document.getElementById('card_variation').value;
                const condition = document.getElementById('condition').value;
                
                // Get auth token
                const authToken = localStorage.getItem('auth_token');
                
                if (!authToken) {
                    alert('Please sign in to get card prices');
                    return;
                }
                
                // Show loading state
                document.getElementById('pricing-results').innerHTML = '<div class="loading">Loading...</div>';
                document.querySelector('.results-section').style.display = 'block';
                
                // Make API request
                fetch('/api/price', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        brand: brand,
                        set_name: set_name,
                        year: year,
                        player_name: player_name,
                        card_number: card_number,
                        card_variation: card_variation,
                        condition: condition
                    })
                })
                .then(response => {
                    if (response.status === 401) {
                        // Token expired or invalid
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('user');
                        window.location.reload();
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data);
                    console.log('Active Listings:', data.active_listings);
                    console.log('Active Listings Length:', data.active_listings ? data.active_listings.length : 0);
                    
                    // Restore the original structure if it was replaced
                    if (!document.getElementById('predicted-price')) {
                        document.getElementById('pricing-results').innerHTML = `
                            <div class="price-summary">
                                <div class="predicted-price">
                                    <h3>Predicted Price: <span id="predicted-price">$0.00</span></h3>
                                    <p>Confidence Score: <span id="confidence-score">0%</span></p>
                                </div>
                                <div class="market-analysis">
                                    <div class="analysis-item">
                                        <span class="label">Market Trend:</span>
                                        <span id="market-trend" class="value">-</span>
                                    </div>
                                    <div class="analysis-item">
                                        <span class="label">Supply Level:</span>
                                        <span id="supply-level" class="value">-</span>
                                    </div>
                                    <div class="analysis-item">
                                        <span class="label">Price Trend:</span>
                                        <span id="price-trend" class="value">-</span>
                                    </div>
                                    <div class="analysis-item">
                                        <span class="label">Average Sale Price:</span>
                                        <span id="avg-sale-price" class="value">-</span>
                                    </div>
                                    <div class="analysis-item">
                                        <span class="label">Average Active Price:</span>
                                        <span id="avg-active-price" class="value">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sales-data">
                                <div id="recent-sales-section" class="collapsible-section">
                                    <button class="collapsible-btn">
                                        Recent Sales <span class="count">(0)</span>
                                        <span class="arrow">▶</span>
                                    </button>
                                    <div class="collapsible-content">
                                        <div class="section-description">
                                            <p>Items that have been sold in the last 90 days</p>
                                        </div>
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Price</th>
                                                    <th>Condition</th>
                                                    <th>Date</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recent-sales-list">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="active-listings-section" class="collapsible-section">
                                    <button class="collapsible-btn">
                                        Active Listings <span class="count">(0)</span>
                                        <span class="arrow">▶</span>
                                    </button>
                                    <div class="collapsible-content">
                                        <div class="section-description">
                                            <p>Items currently available for purchase</p>
                                        </div>
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Price</th>
                                                    <th>Condition</th>
                                                    <th>Type</th>
                                                </tr>
                                            </thead>
                                            <tbody id="active-listings-list">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Reinitialize collapsible sections
                        initializeCollapsibleSections();
                    }
                    
                    // Update basic information
                    const predictedPriceElement = document.getElementById('predicted-price');
                    const confidenceScoreElement = document.getElementById('confidence-score');
                    
                    if (predictedPriceElement) {
                        predictedPriceElement.textContent = `$${data.predicted_price.toFixed(2)}`;
                    }
                    if (confidenceScoreElement) {
                        confidenceScoreElement.textContent = `${(data.confidence_score * 100).toFixed(1)}%`;
                    }
                    
                    // Update market analysis
                    const marketTrendElement = document.getElementById('market-trend');
                    const supplyLevelElement = document.getElementById('supply-level');
                    const priceTrendElement = document.getElementById('price-trend');
                    const avgSalePriceElement = document.getElementById('avg-sale-price');
                    const avgActivePriceElement = document.getElementById('avg-active-price');
                    
                    if (marketTrendElement && data.market_analysis) {
                        marketTrendElement.textContent = data.market_analysis.market_trend || '-';
                    }
                    if (supplyLevelElement && data.market_analysis) {
                        supplyLevelElement.textContent = data.market_analysis.supply_level || '-';
                    }
                    if (priceTrendElement && data.market_analysis) {
                        priceTrendElement.textContent = data.market_analysis.price_trend || '-';
                    }
                    if (avgSalePriceElement && data.market_analysis) {
                        avgSalePriceElement.textContent = data.market_analysis.avg_sale_price ? 
                            `$${data.market_analysis.avg_sale_price.toFixed(2)}` : '-';
                    }
                    if (avgActivePriceElement && data.market_analysis) {
                        avgActivePriceElement.textContent = data.market_analysis.avg_active_price ? 
                            `$${data.market_analysis.avg_active_price.toFixed(2)}` : '-';
                    }
                    
                    // Update recent sales
                    const recentSalesList = document.getElementById('recent-sales-list');
                    if (recentSalesList) {
                        recentSalesList.innerHTML = '';
                        console.log('Recent Sales Data:', data.recent_sales);
                        if (data.recent_sales && data.recent_sales.length > 0) {
                            data.recent_sales.forEach(sale => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${sale.title || 'N/A'}</td>
                                    <td>$${sale.price.toFixed(2)}</td>
                                    <td>${sale.condition || 'Unknown'}</td>
                                    <td>${new Date(sale.date).toLocaleDateString()}</td>
                                `;
                                row.classList.add('recent-sale-row');
                                recentSalesList.appendChild(row);
                            });
                        } else {
                            const row = document.createElement('tr');
                            row.innerHTML = '<td colspan="4" style="text-align: center;">No recent sales found</td>';
                            recentSalesList.appendChild(row);
                        }
                    }
                    
                    // Update recent sales count
                    const recentSalesCount = document.querySelector('#recent-sales-section .count');
                    if (recentSalesCount) {
                        recentSalesCount.textContent = `(${data.recent_sales ? data.recent_sales.length : 0})`;
                    }
                    
                    // Update active listings
                    const activeListingsList = document.getElementById('active-listings-list');
                    if (activeListingsList) {
                        activeListingsList.innerHTML = '';
                        console.log('Active Listings Data:', data.active_listings);
                        console.log('Active Listings Length:', data.active_listings ? data.active_listings.length : 0);
                        
                        if (data.active_listings && data.active_listings.length > 0) {
                            data.active_listings.forEach(listing => {
                                console.log('Processing active listing:', listing);
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${listing.title || 'N/A'}</td>
                                    <td>$${listing.price.toFixed(2)}</td>
                                    <td>${listing.condition || 'Unknown'}</td>
                                    <td>${listing.listing_type || 'N/A'}</td>
                                `;
                                row.classList.add('active-listing-row');
                                activeListingsList.appendChild(row);
                            });
                        } else {
                            console.log('No active listings found in the response');
                            const row = document.createElement('tr');
                            row.innerHTML = '<td colspan="4" style="text-align: center;">No active listings found</td>';
                            activeListingsList.appendChild(row);
                        }
                    } else {
                        console.error('Active listings list element not found in the DOM');
                    }
                    
                    // Update active listings count
                    const activeListingsCount = document.querySelector('#active-listings-section .count');
                    if (activeListingsCount) {
                        activeListingsCount.textContent = `(${data.active_listings ? data.active_listings.length : 0})`;
                    }
                    
                    // Make sure the results section is visible
                    const resultsSection = document.querySelector('.results-section');
                    if (resultsSection) {
                        resultsSection.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('pricing-results').innerHTML = '<div class="error">An error occurred while fetching the price. Please try again.</div>';
                    // Show the results section even if there's an error
                    document.querySelector('.results-section').style.display = 'block';
                });
            });
        });

        function signOut() {
            // Clear local storage
            localStorage.removeItem('user');
            localStorage.removeItem('auth_token');
            
            // Show login section and hide main content
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            
            // Clear user info
            document.getElementById('user-info').textContent = '';
            
            // Reload the page to reset Google Sign-In state
            window.location.reload();
        }
    </script>
</body>
</html> 